services:
  restore-backup:
    image: restic-rclone
    build:
      context: ./images/restic-rclone
      dockerfile: restic-rclone.Dockerfile
    container_name: ${MC_CONTAINER_NAME}-restore-backup
    profiles: ["restore"]
    restart: "no"
    env_file: env/.env
    environment:
      RESTIC_HOSTNAME: ${RESTIC_HOSTNAME}
      RESTIC_PASSWORD: ${RESTIC_PASSWORD}
      RESTIC_REPOSITORY: ${RESTIC_REPOSITORY}
      RCLONE_CONFIG: ${RCLONE_CONFIG}
      MUTEX_REMOTE_DIR: ${MUTEX_REMOTE_DIR}
      XDG_CACHE_HOME: /data/.cache
    user: "${TARGET_UID}:${TARGET_GID}"
    volumes:
      - ./data:/data
      - ./env/rclone.conf:${RCLONE_CONFIG}:ro

  mc:
    image: minecraft-server
    container_name: ${MC_CONTAINER_NAME}
    build:
      context: ./images/minecraft-server/
      dockerfile: ${MC_DOCKERFILE:-mcserver.java21.Dockerfile}
    ports:
      - "25565:25565"
    stop_grace_period: 15m
    env_file:
      - env/.env
    environment:
      UID: ${TARGET_UID}
      GID: ${TARGET_GID}
      # === Server config ===
      VIEW_DISTANCE: ${VIEW_DISTANCE:-15}
      SIMULATION_DISTANCE: ${SIMULATION_DISTANCE:-5}
      IP_SERVER: ${IP_SERVER}
      VERSION: ${VERSION}
      TYPE: ${TYPE}
      FORGE_VERSION: ${FORGE_VERSION}
      NEOFORGE_VERSION: ${NEOFORGE_VERSION}
      FABRIC_LAUNCHER_VERSION: ${FABRIC_LAUNCHER_VERSION}
      FABRIC_LOADER_VERSION: ${FABRIC_LOADER_VERSION}
      INIT_MEMORY: ${INIT_MEMORY:-2G}
      MEMORY: ${MEMORY:-6G}
      MOTD: ${MOTD}
      MAX_PLAYERS: ${MAX_PLAYERS}
      # SEED: ${SEED}
      OPERATORS: ${OPERATORS}
      REMOVE_OLD_MODS: "FALSE"
      ALLOW_FLIGHT: "TRUE"
      SPAWN_PROTECTION: 0
      EULA: "TRUE"
      ONLINE_MODE: "FALSE"
      JVM_OPTS: "-Dfml.queryResult=confirm"

      # === RCON & DDNS ===
      RCON_PASSWORD: ${RCON_PASSWORD}
      DDNS_PROVIDER: ${DDNS_PROVIDER}
      DDNS_DOMAIN: ${DDNS_DOMAIN}
      DDNS_TOKEN: ${DDNS_TOKEN}
      BACKUP: ${BACKUP:-true}

      # === Restic
      RESTIC_PASSWORD: ${RESTIC_PASSWORD}
      RESTIC_REPOSITORY: ${RESTIC_REPOSITORY}
      RESTIC_TAG: ${RESTIC_TAG}
      RESTIC_KEEP_LAST: ${RESTIC_KEEP_LAST}
      
      # === Auto/Sleep
      ENABLE_AUTOSTOP: ${ENABLE_AUTOSTOP}
      AUTOSTOP_TIMEOUT_EST: ${AUTOSTOP_TIMEOUT_EST}
      AUTOSTOP_TIMEOUT_INIT: ${AUTOSTOP_TIMEOUT_INIT}
      ENABLE_AUTOPAUSE: ${ENABLE_AUTOPAUSE}
      MAX_TICK_TIME: ${MAX_TICK_TIME}
      PAUSE_WHEN_EMPTY_SECONDS: ${PAUSE_WHEN_EMPTY_SECONDS}

      MUTEX_REMOTE_DIR: ${MUTEX_REMOTE_DIR}
    volumes:
      - ./data:/data
      - ./env/rclone.conf:${RCLONE_CONFIG}:ro
      - ./overrides:/overrides:ro

  backups:
    image: itzg/mc-backup
    container_name: ${MC_CONTAINER_NAME}-backup
    # removed stop_signal: SIGINT (default is SIGTERM, which is correct)
    # removed custom entrypoint (trap exit 0) so container handles shutdown natively if needed
    environment:
      UID: ${TARGET_UID}
      GID: ${TARGET_GID}
      RCON_HOST: mc
      RCON_PASSWORD: ${RCON_PASSWORD}
      RCON_RETRIES: -1
      RESTIC_HOSTNAME: ${RESTIC_HOSTNAME}
      RESTIC_PASSWORD: ${RESTIC_PASSWORD}
      RESTIC_REPOSITORY: ${RESTIC_REPOSITORY}
      RCLONE_CONFIG: ${RCLONE_CONFIG}
      BACKUP_INTERVAL: "30m"
      BACKUP_METHOD: restic
      SRC_DIR: /data/world
      INITIAL_DELAY: "60" # seconds
      # BACKUP_ON_STOP: "true" # Optional if we want container to do it too, 
      # but we do it in script now (offline backup is safer). 
      # Let's leave it off in container to avoid double backup or conflict?
      # User said "non mi parte il backup in chiusura", implying they expected it.
      # The script offline backup covers this requirement perfectly.
    stop_grace_period: 2m
    volumes:
      - ./data:/data:ro
      - ./env/rclone.conf:${RCLONE_CONFIG}:ro
      - ./backups:/backups
